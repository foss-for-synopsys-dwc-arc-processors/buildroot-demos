From ce05122159a9ad822f9798801d369c4839cc8bbb Mon Sep 17 00:00:00 2001
From: Eugeniy Paltsev <Eugeniy.Paltsev@synopsys.com>
Date: Thu, 23 Jan 2020 16:30:01 +0300
Subject: [PATCH 16/23] HSDKv2: WiFi apply platform quirks

Signed-off-by: Eugeniy Paltsev <Eugeniy.Paltsev@synopsys.com>
---
 arch/arc/plat-hsdk/platform.c | 27 +++++++++++++++++++++++++++
 1 file changed, 27 insertions(+)

diff --git a/arch/arc/plat-hsdk/platform.c b/arch/arc/plat-hsdk/platform.c
index e1c956b59e41..b61186bb6105 100644
--- a/arch/arc/plat-hsdk/platform.c
+++ b/arch/arc/plat-hsdk/platform.c
@@ -41,8 +41,19 @@ static void __init hsdk_init_per_cpu(unsigned int cpu)
 #define CREG_BASE		(ARC_PERIPHERAL_BASE + 0x1000)
 
 #define SDIO_BASE		(ARC_PERIPHERAL_BASE + 0xA000)
+#define SDIO_WIFI_BASE		(ARC_PERIPHERAL_BASE + 0xA800)
 #define SDIO_UHS_REG_EXT	(SDIO_BASE + 0x108)
+#define SDIO_WIFI_UHS_REG_EXT	(SDIO_WIFI_BASE + 0x108)
+
+#define SDIO_WIFI_PWREN		(SDIO_WIFI_BASE + 0x004)
+#define SDIO_WIFI_GPIO		(SDIO_WIFI_BASE + 0x058)
+
 #define SDIO_UHS_REG_EXT_DIV_2	(2 << 30)
+#define SDIO_UHS_REG_EXT_DIV_4	(1 << 30)
+#define SDIO_UHS_EXT_PHASE90	0x1
+#define SDIO_UHS_EXT_PHASE180	0x2
+#define SDIO_UHS_REG_EXT_DRV_PHASE180	(SDIO_UHS_EXT_PHASE180 << 23)
+#define SDIO_UHS_REG_EXT_SAMPL_PHASE90	(SDIO_UHS_EXT_PHASE90 << 16)
 
 #define HSDK_GPIO_INTC          (ARC_PERIPHERAL_BASE + 0x3000)
 
@@ -334,6 +345,22 @@ static void __init hsdk_init_early(void)
 	 */
 	iowrite32(SDIO_UHS_REG_EXT_DIV_2, (void __iomem *) SDIO_UHS_REG_EXT);
 
+	/*
+	 * UHS_REG_EXT[24:23] -> clk_drv_phase_ctrl[1:0] = 1 -> 90 degrees
+	 * UHS_REG_EXT[17:16] -> clk_sample_phase_ctrl[1:0] = 1 -> 90 degrees
+	 */
+	iowrite32(0x00810000, (void __iomem *) SDIO_WIFI_UHS_REG_EXT);
+	(void)ioread32((void __iomem *) SDIO_WIFI_UHS_REG_EXT);
+	//pr_info("  PAL: '0x%08x' to %s (0x%08x)\n", (u32)ioread32((void __iomem *) SDIO_WIFI_UHS_REG_EXT), "SDIO_WIFI_UHS_REG_EXT", SDIO_WIFI_UHS_REG_EXT);
+	/* Set PWREN[2] to disable EBI */
+	iowrite32(3, (void __iomem *) SDIO_WIFI_PWREN);
+	(void)ioread32((void __iomem *) SDIO_WIFI_PWREN);
+	//pr_info("  PAL: '0x%08x' to %s (0x%08x)\n", (u32)ioread32((void __iomem *) SDIO_WIFI_PWREN), "SDIO_WIFI_PWREN", SDIO_WIFI_PWREN);
+	/* Drive high ebi_addr[XX] to enable level shifter IC20 */
+	iowrite32((1 << 11), (void __iomem *) SDIO_WIFI_GPIO);
+	(void)ioread32((void __iomem *) SDIO_WIFI_GPIO);
+	//pr_info("  PAL: '0x%08x' to %s (0x%08x)\n", (u32)ioread32((void __iomem *) SDIO_WIFI_GPIO), "SDIO_WIFI_GPIO", SDIO_WIFI_GPIO);
+
 	hsdk_enable_gpio_intc_wire();
 }
 
-- 
2.16.2

