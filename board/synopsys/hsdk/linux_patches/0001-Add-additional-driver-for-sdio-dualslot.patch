From a6f204d3cc59ced30fede26429e94f3f8789a79d Mon Sep 17 00:00:00 2001
From: Evgeniy Didin <Evgeniy.Didin@synopsys.com>
Date: Mon, 23 Apr 2018 20:58:54 +0300
Subject: [PATCH] Add additional driver for sdio dualslot

Signed-off-by: Eugeniy Paltsev <Eugeniy.Paltsev@synopsys.com>
Signed-off-by: Evgeniy Didin <Evgeniy.Didin@synopsys.com>
---
 drivers/mmc/host/dw_mmc.c | 17 +++++++++++++++++
 1 file changed, 17 insertions(+)

diff --git a/drivers/mmc/host/dw_mmc.c b/drivers/mmc/host/dw_mmc.c
index e0d30f56cc59..f2b7990fae62 100644
--- a/drivers/mmc/host/dw_mmc.c
+++ b/drivers/mmc/host/dw_mmc.c
@@ -1609,6 +1609,23 @@ static void dw_mci_set_ios(struct mmc_host *mmc, struct mmc_ios *ios)
 		regs = mci_readl(slot->host, PWREN);
 		regs |= (1 << slot->id);
 		mci_writel(slot->host, PWREN, regs);
+ 	/* TODO: PAL: revisit HSDK specific part: what is it all about */
+        regs = mci_readl(slot->host, PWREN);
+        /* DEF: Set PWREN[2] to disable EBI */
+        regs |= (1 << 2);
+        /* PAL: Set PWREN[1] to disable EBI */
+        regs |= (1 << 1);
+        mci_writel(slot->host, PWREN, regs);
+        /* PAL: Drive high ebi_addr[18] to enable level shifter IC20 */
+        regs = mci_readl(slot->host, GPIO);
+        regs |= (1 << 13);
+        mci_writel(slot->host, GPIO, regs);
+        /* TODO: PAL: remove HSDK specific code
+         * UHS_REG_EXT[24:23] -> clk_drv_phase_ctrl[1:0] = 1 -> 90 degrees
+         * UHS_REG_EXT[17:16] -> clk_sample_phase_ctrl[1:0] = 1 -> 90 degrees
+         * UHS_REG_EXT[31:30] -> ext_clk_mux_ctrl[1:0] = 2 -> div-by-2
+         */
+        *(u32*)0xf000A108 = 0x00810000 | (2 << 30);
 		break;
 	case MMC_POWER_ON:
 		set_bit(DW_MMC_CARD_IS_ON, &slot->flags);
-- 
2.16.2

